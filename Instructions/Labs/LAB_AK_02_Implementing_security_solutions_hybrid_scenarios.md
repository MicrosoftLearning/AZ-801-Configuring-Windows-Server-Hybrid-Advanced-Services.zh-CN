---
lab:
  title: 实验室：在混合场景中实现安全解决方案
  type: Answer Key
  module: 'Module 2: Implementing Security Solutions in Hybrid Scenarios'
---

# 实验室解答：在混合场景中实现安全解决方案

**注意：** 我们提供交互式实验室模拟 ，让你能按照自己的节奏点击浏览此实验室。 你可能会发现交互式模拟与托管实验室之间存在细微差异，但演示的核心概念和思想是相同的。 

## 练习 1：创建 Azure Log Analytics 工作区

#### 任务 1：创建一个 Azure Log Analytics 工作区 

1. 连接到 **SEA-SVR2**，然后根据需要使用讲师提供的凭据登录。
1. 在 SEA-SVR2 上，启动 Microsoft Edge，转到 Azure 门户 (`https://portal.azure.com/`)，然后使用具有要在此实验室中使用的订阅的“所有者”角色的用户帐户的凭据登录。
1. 在 SEA-SVR2 上，在 Azure 门户的工具栏上的“搜索资源、服务和文档”文本框中，搜索并选择“Log Analytics 工作区”，然后从“Log Analytics 工作区”页中选择“+ 创建”    。
1. 在“**创建 Log Analytics 工作区**”选项卡的“**基本信息**”选项卡上，输入以下设置，选择“**查看 + 创建**”，然后选择“**创建**”：

   | 设置 | 值 |
   | --- | --- |
   | 订阅 | 你在此实验室中使用的 Azure 订阅的名称 |
   | 资源组 | 新资源组 AZ801-L0201-RG 的名称 |
   | Log Analytics 工作区 | 任何唯一名称 |
   | 区域 | 选择你附近的区域 |

   >备注：请等待部署完成。 部署大约需要 1 分钟的时间完成。

## 练习 2：配置 Microsoft Defender for Cloud

#### 任务 1：启用 Defender for Cloud 和自动代理安装

1. 在 SEA-SVR2 上，在 Azure 门户的“搜索资源、服务和文档”文本框中的工具栏上，搜索并选择 Microsoft Defender for Cloud  。
1. 在“**Microsoft Defender for Cloud \|概述**”页上，选择”**单击此处升级>**“链接。 在“**入门指南**”页选择“**升级**”。

   > **注意：** 你的订阅可能已启用 Defender for Cloud 增强的安全性，在这种情况下，无需升级，可以继续执行下一个任务。

#### 任务 2：启用 Defender for Cloud 的增强安全性

1. 在 SEA-SVR2 上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“Microsoft Defender for Cloud | 概览”页左侧垂直菜单的“管理”部分，选择“环境设置”   。
1. 在“环境设置”页上，选择代表你的 Azure 订阅的条目。
1. 在“**设置 \| Defender 计划**”页上，选择“**启用所有计划**”。 在“**计划选择**”页，选择“**Microsoft Defender for API 计划 1**”，然后选择“**保存**”。
1. 在“**设置 | Defender 计划**”页上，选择“**保存**”。

   > **注意：** 你可能会遇到有关自动预配更新失败的通知。 请放心忽略这些通知，因为你只会使用本实验室中的服务器计划。 注意，可以选择性地禁用同一页面上列出的单个 Microsoft Defender 计划。

1. 将“服务器”外的所有其他计划设置为“关闭”，然后选择“保存”。 当被问及是否确定要降级时，请确认。

   > **注意：** 当显示“数据库”计划的资源类型选择时，请将每个条目切换为“关闭”，然后选择“继续”。 对于本实验室，你可以放心地忽略有关单个数据库资源无法保存的任何通知。

1.  选择“ **设置和监视**” 选项卡，在扩展列表中，将“**来宾配置代理(预览版)**”设置为“ **打开**”。
1. 在“**设置和监视**”选项卡的扩展列表中，将“**计算机漏洞评估**”设置为“ **打开**”，然后选择“ **编辑配置**” 链接。
1. 在“**扩展部署配置**”页上，确保选中“**Microsoft Defender 漏洞管理**”选项，然后选择“**应用**”。
1. 在“设置和监视”页上，选择“继续” 。   
1. 在“Defender 计划”页上，选择“保存”，然后关闭页面。
1. 浏览回“Microsoft Defender for Cloud | 概览”页，然后在左侧垂直菜单的“管理”部分，选择“环境设置”  。
1. 在“**环境设置**”页上，展开代表你的 **Azure 订阅**的条目，并选择代表你在上一个练习中创建的 **Log Analytics 工作区**的条目。
1. 在“**设置 \| Defender 计划**”页上，启用**服务器** Defender 计划，然后选择“**保存**”。

   > **注意：** 若要启用所有 Defender for Cloud 功能（包括威胁防护功能），必须在包含相应工作负载的订阅上启用增强的安全性功能。 如果在工作区级别启用它，则不会为 Azure 资源启用实时 VM 访问、自适应应用程序控制和网络检测功能。 此外，只在工作区级别提供两种 Microsoft Defender 计划：适用于服务器的 Microsoft Defender，以及适用于计算机上的 SQL Server 的 Microsoft Defender。

1. 在“设置 \| Defender 计划”页左侧垂直菜单的“设置”部分，选择“数据收集”  。
1. 在“设置 \| 数据收集”上，选择“所有事件”，然后选择“保存”  。

   > **注意：** 在 Defender for Cloud 中选择数据集合只会影响 Log Analytics 工作区中安全事件的存储。 无论你选择在工作区中存储哪一级别的安全事件，Log Analytics 代理仍将收集和分析 Defender for Cloud 的威胁防护所需的安全事件。 选择存储安全事件可以在工作区中调查、搜索和审核这些事件。

## 练习 3：预配运行 Windows Server 的 Azure VM

#### 任务 1：启动 Azure Cloud Shell

1. 在 SEA-SVR2 上，在 Azure 门户中，通过选择搜索文本框旁边的工具栏图标打开“Cloud Shell”窗格。
1. 如果系统提示选择 Bash 或 PowerShell，请选择 PowerShell  。

   >备注：如果这是你第一次启动 Cloud Shell 且向你显示了“未装载任何存储”消息，请选择要在此实验室中使用的订阅，然后选择“创建存储”  。

#### 任务 2：使用 Azure 资源管理器模板部署 Azure VM

1. 运行以下脚本创建一个新的资源组（将 `<Azure_region>` 占位符替换为你打算在此实验室中部署资源的 Azure 区域的名称）：

   >注意：可以使用 (Get-AzLocation).Location 命令列出可用 Azure 区域的名称 ：

   ```powershell 
   New-AzResourceGroup -Name 'AZ801-L0202-RG' -Location '<Location>'
   ```

1. 关闭 Cloud Shell。
1. 在工具栏上的 **“搜索资源、服务和文档”文本框**中，搜索并选择“**部署自定义模板**”。
1. 在“自定义部署”页面中，选择“在编辑器中生成自己的模板” 。
1. 在“**编辑模板**”页上，选择“**加载文件**”，上传模板文件 **L02-rg_template.json**，然后选择“**保存**”。
1. 在“**自定义部署**”页上，指定以下设置，并将其他设置保留为默认值：

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|**AZ801-L0202-RG**|
   |区域|可以在其中预配 Azure VM 的 Azure 区域的名称|
   |管理员用户名| 所选管理员名称
   |管理员密码|选择所选的强密码

1. 选择**查看 + 创建**，然后选择**创建**。

   >**注意**：部署可能需要大约 3 分钟。

1. 验证部署是否已成功完成。


## 练习 4：将本地 Windows Server 载入 Microsoft Defender for Cloud 和 Azure 更新管理器

#### 任务 1：在本地服务器上安装 Azure Arc 代理

1. 在 **SEA-SVR2** 上，在显示 Azure 门户的 Microsoft Edge 窗口中，键入 **ARC**，然后选择 **Azure Arc**。
1. 在“ **Azure Arc 资源**”下的导航窗格中选择“ **计算机**”
1. 选择“ **+ 添加/创建**”，然后在下拉列表中选择“ **添加计算机**”。 
1. 在“**添加单一服务器**”部分选择“ **生成脚本**” 。 
1. 在“ **使用 Azure Arc 添加服务器**” 页面中，在“ **项目详细信息**”下选择之前创建的资源组 (AZ801-L0201-RG)。 
1. 在“**服务器详细信息**”下，将区域选为“ **(美国)东部**”。 
1. 查看 SQL Server 和连接选项。 保留默认值，并选择“ **下一步**”。 
1. 在“**标记**”选项卡中，查看默认可用标记，然后选择“ **下一步**”。 
1. 在“**使用 Azure Arc 添加服务器**”选项卡中，向下滚动并选择“ **下载**” 按钮。

   >提示：如果浏览器阻止下载，请在 Microsoft Edge 浏览器中允许下载；选择省略号按钮 (…)，然后选择“保留”。

1. 右键单击“**Windows 开始**”按钮，然后选择“ **Windows PowerShell (管理员)**”

   > 如果收到 UAC 提示，请在“*用户名*”中输入“ **Administrator**”，在“*密码*”中输入“Passw0rd!”。

1. 键入 **cd C:\Users\Administrator\Downloads** 或导航到下载脚本的文件夹。  
1. 键入  `Set-ExecutionPolicy -ExecutionPolicy Unrestricted` ，然后按 **Enter**。 
1. 输入“ **A**” ，表示**全部接受**，然后按 **Enter**。
1. 键入  `.\OnboardingScript.ps1` ，然后按 **Enter**。 
1. 输入“ **R**” 以**运行一次**，然后按 **Enter**（这可能需要几分钟时间）。

   >安装过程将打开新的 Microsoft Edge 浏览器标签页，以对 Azure Arc 代理进行身份验证。 选择管理员帐户，等待“身份验证完成”消息。 返回到 Windows PowerShell 并等待安装完成，然后再关闭窗口。

1. 返回到下载脚本的 Azure 门户页面，然后选择“ **关闭**”。
1. 关闭“ **使用 Azure Arc 添加服务器**” 页，然后导航回“**Azure Arc 计算机**” 页。
1.  选择“ **刷新**” ，直到出现 **SEA-SVR2** 服务器名称，并且 ARC 控制台中的状态为“ **已连接**”。 

#### 任务 2：在 ARC 计算机上启用“更改跟踪和清单”

1. 在 **Azure Arc- Machines- SEA-SVR2** 下的导航窗格中，在“**操作**”下选择“**清单**”。   
1. 在“**更改跟踪和清单**”页上，单击“**启用**”。

   >请注意，你创建的 Log Analytics 工作区列在“**使用 AMA 启用更改跟踪和清单功能**”下。

1. 等待更改跟踪功能的部署完成。 这可能需要长达 5 分钟的时间，因此请继续执行后续步骤。


#### 任务 3：使用“见解”启用“监视”

1. 导航到 **SEA-SVR2** Azure Arc 计算机，然后在“**设置**”下选择“**扩展**”。  

   >请注意添加了 ChangeTracking 和 Azure Monitor 代理扩展。

1. 在“**监视**”下选择“**见解**”，然后选择“**启用**”。  
1. 在“**数据收集规则**”下的“**监视配置**”页上，选择“**新建**”。
1. 在“**创建新规则**”页中，输入“**ARC**”作为“**数据收集规则**”的名称。
1. 在“**进程和依赖项**”下，选择“**启用进程和依赖项（映射）**”。
1. 保留你在此实验室中使用的 Azure 订阅的名称。
1. 从“**Log Analytics 工作区**”下拉菜单选择你之前创建的 Log Analytics 工作区。
1. 选择“**创建**”，然后选择“**配置**”。

   >**注意**：此部署可能需要花一些时间。 请继续完成其他任务，你可以稍后返回此任务。

#### 任务 4：使用“Windows 更新”启用“监视” 

   在 **SEA-SVR2** 上，“Windows 更新”默认处于禁用状态。 请确保未禁用 **SEA-SVR2** 服务器上的“Windows 更新”。 必须先启用它，然后才能继续下一步。

1. 打开服务控制台并选择“**Windows 更新**”服务。

1. 右键单击“**Windows 更新**”，然后从上下文菜单中选择“**属性**”。 将启动类型设置为“**自动**”并且启动该服务。 
1. 关闭“服务”控制台。
1. 在“Azure 门户”搜索栏中，键入“**Azure 更新管理器**”。
1. 在导航窗格中的“**资源**”下，选择“**计算机**”。 你应该会看到 **SEA-SVR2** 已启用 Azure Arc 的服务器列在“**计算机**”页面上。 选择 **SEA-SVR2** 计算机。
1. 在“**推荐更新**”选项卡中的“**定期评估**”下，单击“**立即启用**”。
1. 在已启用 **SEA-SVR2** Arc 的服务器的下拉菜单中，在“**定期评估**”下，选择“**启用**”，然后选择“**保存**”。 
1. 在“更新”页上，选择“检查更新”********。 
1.  在“**立即触发评估**”中，选择“**确定**”。

   > **注意：** 缺失的更新将在几分钟后出现。 可以定期重新访问 Azure Arc 计算机，并且应该会在不久后看到反映的更新。


#### 任务 5：验证 Azure Policy 合规性、更改跟踪、清单、见解监视和 Azure 更新

1.  导航到 **SEA-SVR2** Azure Arc 计算机，然后在“**监视**”下的导航窗格中选择“**见解**”。

1.  选择“**分析数据**”。 你应该能够看到性能数据。  
1.  选择“**映射**”选项卡并查看依赖项映射。  

   >**注意**：如果未看到任何数据，请返回到“**性能**”选项卡并刷新。 然后刷新“**映射**”部分。 你应该会看到 **SEA-SVR2** 的数据和进程依赖项信息。

1.  在导航窗格中的“**操作**”下，选择“**清单**以”查看清单数据。   
1.  选择“**更改跟踪**”以查看已更改的数据。  

## 练习 5：取消预配 Azure 环境 

#### 任务 1：在 Cloud Shell 中启动 PowerShell 会话

1. 在 SEA-SVR2 上，在显示 Azure 门户的 Microsoft Edge 窗口中，通过选择 Cloud Shell 图标打开 Cloud Shell 窗格。

#### 任务 2：标识实验室中预配的所有 Azure 资源

1. 在 Cloud Shell 窗格中，运行以下命令，列出你在此实验室中创建的所有资源组：

   ```powershell
   Get-AzResourceGroup -Name 'AZ801-L02*'
   ```

   > 备注：验证输出是否仅包含你在此实验室中创建的资源组。 此任务中将删除该组。

1. 运行以下命令，删除在此实验室中创建的所有资源组：

   ```powershell
   Get-AzResourceGroup -Name 'AZ801-L02*' | Remove-AzResourceGroup -Force -AsJob
   ```

   >备注：该命令异步执行（由 -AsJob 参数决定），因此，虽然你可以随后立即在同一个 PowerShell 会话中运行另一个 PowerShell 命令，但需要几分钟才能实际删除资源组。
